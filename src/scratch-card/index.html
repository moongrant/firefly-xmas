<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¤ç«äº’å¯„äº‹åŠ¡å±€ - åœ£è¯ç›²ç›’è®¡åˆ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            height: 100vh;
            background-image: url('32d03e15-f173-4c18-9447-9b8d065e9ff9.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* ç™»å½•ç•Œé¢ */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 50px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .login-subtitle {
            font-size: 13px;
            color: #888;
            margin-bottom: 30px;
            letter-spacing: 0.5px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            color: #666;
            text-align: left;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }

        .input-field:focus {
            outline: none;
            border-color: #5a7c8a;
            background: white;
            box-shadow: 0 0 0 3px rgba(90, 124, 138, 0.1);
        }

        .submit-btn {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, #5a7c8a 0%, #4a6c7a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(90, 124, 138, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .error-msg {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 10px;
            display: none;
        }

        .error-msg.show {
            display: block;
        }

        /* æ¸¸æˆç•Œé¢ */
        .game-container {
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .game-container.active {
            display: flex;
        }

        .header {
            position: absolute;
            top: 40px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
        }

        .header-title {
            font-size: 28px;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .header-subtitle {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: 1px;
        }

        .game-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .scratch-container {
            position: relative;
            width: 450px;
            height: 340px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
            background: white;
        }

        .scratch-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            border-radius: 20px;
            display: block;
        }

        #contentCanvas {
            z-index: 1;
            background: white;
        }

        #scratchCanvas {
            z-index: 2;
        }

        .bottom-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 500px;
        }

        .prize-display {
            min-height: 40px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            flex: 1;
        }

        .address-display {
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            border-top: 2px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }

        .address-display-content {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            cursor: pointer;
            transition: all 0.3s ease;
            word-break: break-all;
        }

        .address-display-content:hover {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .instruction {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
        }

        .scratch-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 42px;
            font-weight: 900;
            background: linear-gradient(135deg, #5a7c8a 0%, #4a6c7a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(90, 124, 138, 0.5);
            filter: drop-shadow(0 0 15px rgba(90, 124, 138, 0.4));
            margin-bottom: 25px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-title">è¤ç«äº’å¯„äº‹åŠ¡å±€</div>
            <div class="login-subtitle">åœ£è¯ç›²ç›’è®¡åˆ’</div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label class="input-label">è®¿é—®ç </label>
                    <input
                        type="text"
                        id="codeInput"
                        class="input-field"
                        placeholder="è¯·è¾“å…¥è®¿é—®ç "
                        autocomplete="off"
                    >
                </div>
                <button type="submit" class="submit-btn">è¿›å…¥ç›²ç›’è®¡åˆ’</button>
                <div class="error-msg" id="errorMsg">è®¿é—®ç æ— æ•ˆæˆ–ä¸å­˜åœ¨</div>
            </form>
        </div>
    </div>

    <!-- æ¸¸æˆç•Œé¢ -->
    <div class="game-container" id="gameContainer">
        <div class="header">
            <div class="header-title">è¤ç«äº’å¯„äº‹åŠ¡å±€</div>
            <div class="header-subtitle">åœ£è¯ç›²ç›’è®¡åˆ’</div>
        </div>

        <div class="game-content">
            <div class="instruction">è½»è½»åˆ®å¼€ç›²ç›’ï¼Œå‘ç°ä½ çš„æƒŠå–œ</div>

            <div class="scratch-label">MYSTERY BOX</div>

            <div class="scratch-container">
                <canvas id="contentCanvas" class="scratch-canvas"></canvas>
                <canvas id="scratchCanvas" class="scratch-canvas"></canvas>
            </div>

            <div class="bottom-info">
                <div class="prize-display" id="prizeDisplay"></div>
            </div>
        </div>
    </div>

    <script>
        const loginContainer = document.getElementById('loginContainer');
        const gameContainer = document.getElementById('gameContainer');
        const loginForm = document.getElementById('loginForm');
        const codeInput = document.getElementById('codeInput');
        const errorMsg = document.getElementById('errorMsg');
        const scratchCanvas = document.getElementById('scratchCanvas');
        const contentCanvas = document.getElementById('contentCanvas');
        const ctx = scratchCanvas.getContext('2d');
        const contentCtx = contentCanvas.getContext('2d');
        const prizeDisplay = document.getElementById('prizeDisplay');

        const STORAGE_KEY = 'addressFormData';

        let isDrawing = false;
        let selectedUserData = null;
        let revealed = false;

        function handleLogin(event) {
            event.preventDefault();
            const code = codeInput.value.trim();

            // éªŒè¯ä»£ç æ˜¯å¦ä¸ºç©º
            if (code === '') {
                errorMsg.classList.add('show');
                return;
            }

            // ä» localStorage è·å–æ•°æ®
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const userData = allData.find(item => item.code === code);

            if (!userData) {
                errorMsg.classList.add('show');
                return;
            }

            errorMsg.classList.remove('show');
            selectedUserData = userData;
            loginContainer.style.display = 'none';
            gameContainer.classList.add('active');
            initGame();
        }

        function initGame() {
            // è®¾ç½®canvaså°ºå¯¸
            scratchCanvas.width = 450;
            scratchCanvas.height = 340;
            contentCanvas.width = 450;
            contentCanvas.height = 340;

            drawContentLayer();
            drawScratchLayer();

            // é¼ æ ‡äº‹ä»¶
            scratchCanvas.addEventListener('mousedown', startScratch);
            scratchCanvas.addEventListener('mousemove', scratch);
            scratchCanvas.addEventListener('mouseup', stopScratch);
            scratchCanvas.addEventListener('mouseout', stopScratch);

            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            scratchCanvas.addEventListener('touchstart', handleTouch);
            scratchCanvas.addEventListener('touchmove', handleTouch);
            scratchCanvas.addEventListener('touchend', stopScratch);
        }

        function drawContentLayer() {
            // åœ¨contentCanvasä¸Šç»˜åˆ¶å†…å®¹ï¼ˆæ–‡å­—ï¼‰
            const bgGradient = contentCtx.createLinearGradient(0, 0, contentCanvas.width, contentCanvas.height);
            bgGradient.addColorStop(0, '#ffffff');
            bgGradient.addColorStop(1, '#f5f5f5');
            contentCtx.fillStyle = bgGradient;
            contentCtx.fillRect(0, 0, contentCanvas.width, contentCanvas.height);

            if (!selectedUserData) return;

            // ç»˜åˆ¶ç”¨æˆ·çš„æ¶ˆæ¯ï¼ˆå¤§å­—ä½“ï¼Œæ·±çº¢è‰²ï¼‰
            if (selectedUserData.message) {
                const message = selectedUserData.message;

                // è®¾ç½®å­—ä½“å¤§å°ï¼Œæ ¹æ®æ–‡æœ¬é•¿åº¦åŠ¨æ€è°ƒæ•´
                let fontSize = 22;
                if (message.length > 20) {
                    fontSize = 18;
                }
                if (message.length > 30) {
                    fontSize = 14;
                }

                contentCtx.font = `bold ${fontSize}px "Segoe UI", "Microsoft YaHei", sans-serif`;
                contentCtx.fillStyle = '#d32f2f';
                contentCtx.textAlign = 'center';
                contentCtx.textBaseline = 'middle';

                // æŒ‰å­—ç¬¦å¤„ç†æ¢è¡Œ
                const chars = message.split('');
                let line = '';
                let lines = [];
                let maxWidth = contentCanvas.width - 40;

                for (let char of chars) {
                    const testLine = line + char;
                    const metrics = contentCtx.measureText(testLine);
                    if (metrics.width > maxWidth && line) {
                        lines.push(line);
                        line = char;
                    } else {
                        line = testLine;
                    }
                }
                if (line) {
                    lines.push(line);
                }

                // è®¡ç®—è¡Œé«˜å’Œæ€»é«˜åº¦
                const lineHeight = fontSize + 6;
                const totalHeight = lines.length * lineHeight;
                let startY = (contentCanvas.height / 2) - (totalHeight / 2) - 50;

                // ç»˜åˆ¶æ¯ä¸€è¡Œæ–‡å­—
                for (let i = 0; i < lines.length; i++) {
                    contentCtx.fillText(lines[i], contentCanvas.width / 2, startY + (i * lineHeight));
                }
            }

            // ç»˜åˆ¶åœ°å€ï¼ˆå°å­—ä½“ï¼Œç°è‰²ï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼‰
            if (selectedUserData.address) {
                const address = selectedUserData.address;

                // åœ°å€ä½¿ç”¨è¾ƒå°çš„å­—ä½“
                let addressFontSize = 11;
                contentCtx.font = `${addressFontSize}px "Segoe UI", "Microsoft YaHei", sans-serif`;
                contentCtx.fillStyle = '#999999';
                contentCtx.textAlign = 'center';
                contentCtx.textBaseline = 'middle';

                // å¤„ç†åœ°å€æ¢è¡Œ
                const addressChars = address.split('');
                let addressLine = '';
                let addressLines = [];
                let maxAddressWidth = contentCanvas.width - 50;

                for (let char of addressChars) {
                    const testLine = addressLine + char;
                    const metrics = contentCtx.measureText(testLine);
                    if (metrics.width > maxAddressWidth && addressLine) {
                        addressLines.push(addressLine);
                        addressLine = char;
                    } else {
                        addressLine = testLine;
                    }
                }
                if (addressLine) {
                    addressLines.push(addressLine);
                }

                // ç»˜åˆ¶åœ°å€è¡Œ
                const addressLineHeight = addressFontSize + 4;
                let addressStartY = contentCanvas.height - 60;

                for (let i = 0; i < addressLines.length; i++) {
                    contentCtx.fillText(addressLines[i], contentCanvas.width / 2, addressStartY + (i * addressLineHeight));
                }
            }
        }

        function drawScratchLayer() {
            // ç»˜åˆ¶åˆ®åˆ®ä¹æ¶‚å±‚ï¼ˆç›–ä½å†…å®¹çš„ç°è‰²å±‚ï¼‰
            const gradient = ctx.createLinearGradient(0, 0, scratchCanvas.width, scratchCanvas.height);
            gradient.addColorStop(0, '#e8d4b8');
            gradient.addColorStop(1, '#d4b896');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, scratchCanvas.width, scratchCanvas.height);

            // æ·»åŠ ç»†è‡´çš„çº¹ç†æ•ˆæœ
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.08)';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < scratchCanvas.width; i += 6) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, scratchCanvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < scratchCanvas.height; i += 6) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(scratchCanvas.width, i);
                ctx.stroke();
            }

            // æ·»åŠ è£…é¥°æ€§çš„è¾¹æ¡†
            ctx.strokeStyle = 'rgba(90, 124, 138, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(5, 5);
            ctx.lineTo(scratchCanvas.width - 5, 5);
            ctx.lineTo(scratchCanvas.width - 5, scratchCanvas.height - 5);
            ctx.lineTo(5, scratchCanvas.height - 5);
            ctx.closePath();
            ctx.stroke();

            // æç¤ºæ–‡æ¡ˆ
            ctx.save();
            ctx.font = 'bold 34px "Segoe UI", "Microsoft YaHei", sans-serif';
            ctx.fillStyle = 'rgba(90, 124, 138, 0.85)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('è¯·åˆ®ä¸€åˆ®', scratchCanvas.width / 2, scratchCanvas.height / 2);
            ctx.restore();
        }

        function startScratch(e) {
            if (!revealed) {
                isDrawing = true;
                scratch(e);
            }
        }

        function stopScratch() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            if (!revealed && e.touches.length > 0) {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                scratchCanvas.dispatchEvent(mouseEvent);
            }
        }

        function scratch(e) {
            if (!isDrawing) return;

            const rect = scratchCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // æ¸…é™¤åœ†å½¢åŒºåŸŸ
            ctx.clearRect(x - 22, y - 22, 44, 44);

            // æ£€æŸ¥æ˜¯å¦å·²åˆ®å¼€è¶³å¤Ÿé¢ç§¯
            checkScratchProgress();
        }

        function checkScratchProgress() {
            // è·å–åˆ®åˆ®ä¹canvasçš„åƒç´ æ•°æ®
            const imageData = ctx.getImageData(0, 0, scratchCanvas.width, scratchCanvas.height);
            const data = imageData.data;

            // è®¡ç®—é€æ˜åƒç´ æ•°é‡ï¼ˆæ¸…é™¤çš„åŒºåŸŸï¼‰
            let transparentPixels = 0;
            for (let i = 3; i < data.length; i += 4) {
                if (data[i] < 128) {
                    transparentPixels++;
                }
            }

            // è®¡ç®—åˆ®å¼€ç™¾åˆ†æ¯”ï¼ˆè¶…è¿‡30%æ—¶è‡ªåŠ¨æ˜¾ç¤ºå¥–é¡¹ï¼‰
            const totalPixels = scratchCanvas.width * scratchCanvas.height;
            const scratchPercentage = transparentPixels / totalPixels;

            if (scratchPercentage > 0.3 && !revealed) {
                revealPrize();
            }
        }

        function revealPrize() {
            revealed = true;
            // æ¸…é™¤æ‰€æœ‰æ¶‚å±‚
            ctx.clearRect(0, 0, scratchCanvas.width, scratchCanvas.height);

            if (!selectedUserData) return;

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            const prizeDisplay = document.getElementById('prizeDisplay');
            const tipsElement = document.createElement('div');
            tipsElement.style.fontSize = '13px';
            tipsElement.style.color = 'rgba(255, 255, 255, 0.8)';
            tipsElement.textContent = 'ğŸ’¡ ç‚¹å‡»ä¸‹æ–¹åœ°å€å¯å¤åˆ¶';
            prizeDisplay.appendChild(tipsElement);

            // ä¸ºåˆ®å¥–åŒºåŸŸçš„åœ°å€æ·»åŠ å¤åˆ¶åŠŸèƒ½
            scratchCanvas.addEventListener('click', function(e) {
                const rect = scratchCanvas.getBoundingClientRect();
                const y = e.clientY - rect.top;
                // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨åœ°å€åŒºåŸŸï¼ˆä¸‹æ–¹ï¼‰
                if (y > scratchCanvas.height - 80) {
                    navigator.clipboard.writeText(selectedUserData.address).then(() => {
                        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                        const originalText = tipsElement.textContent;
                        tipsElement.textContent = 'âœ“ åœ°å€å·²å¤åˆ¶';
                        setTimeout(() => {
                            tipsElement.textContent = originalText;
                        }, 2000);
                    });
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºç™»å½•ç•Œé¢
        window.addEventListener('load', () => {
            codeInput.focus();
        });
    </script>
</body>
</html>
